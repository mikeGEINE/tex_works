\subsection{Модуль \ocamlinlinecode{TOTP.\allowbreak{}Make}}\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make}%
\ocamlinlinecode{Make} создаёт стратегию для предоставленной модели с предоставленными ответами.

\subsubsection{Параметры\label{parameters}}%
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-1-R}\ocamlcodefragment{\ocamltag{keyword}{module} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-1-R]{\ocamlinlinecode{R}}}\ocamlcodefragment{ : \ocamltag{keyword}{sig}}\begin{ocamlindent}\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-1-R-val-response+u+error}\ocamlcodefragment{\ocamltag{keyword}{val} response\_\allowbreak{}error : \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$} \hyperref[xref-unresolved]{\ocamlinlinecode{Base}}.\allowbreak{}Error.\allowbreak{}t \ocamltag{arrow}{$\rightarrow$} \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}response \hyperref[xref-unresolved]{\ocamlinlinecode{Lwt}}.\allowbreak{}t}\begin{ocamlindent}Этот шаблон используется для демонстрации различных ошибок.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-1-R-val-response+u+secret}\ocamlcodefragment{\ocamltag{keyword}{val} response\_\allowbreak{}secret : \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$} string \ocamltag{arrow}{$\rightarrow$} \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}response \hyperref[xref-unresolved]{\ocamlinlinecode{Lwt}}.\allowbreak{}t}\begin{ocamlindent}Этот ответ используется во время настройки TOTP. В рамках этого шага пользователям предоставляется секрет, который им необъодимо занести в их генератор OTP.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-1-R-val-response+u+enabled}\ocamlcodefragment{\ocamltag{keyword}{val} response\_\allowbreak{}enabled : \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$} \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}response \hyperref[xref-unresolved]{\ocamlinlinecode{Lwt}}.\allowbreak{}t}\begin{ocamlindent}Этот ответ информирует пользователя об успешном включении TOTP.\end{ocamlindent}%
\medbreak
\end{ocamlindent}%
\ocamlcodefragment{\ocamltag{keyword}{end}}\\
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M}\ocamlcodefragment{\ocamltag{keyword}{module} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M]{\ocamlinlinecode{M}}}\ocamlcodefragment{ : \ocamltag{keyword}{sig}}\begin{ocamlindent}\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t}\ocamlcodefragment{\ocamltag{keyword}{type} t}\\
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-val-otp+u+secret}\ocamlcodefragment{\ocamltag{keyword}{val} otp\_\allowbreak{}secret : \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{t}} \ocamltag{arrow}{$\rightarrow$} string}\begin{ocamlindent}Извлекает секрет TOTP для пользователся.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-val-otp+u+enabled}\ocamlcodefragment{\ocamltag{keyword}{val} otp\_\allowbreak{}enabled : \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{t}} \ocamltag{arrow}{$\rightarrow$} bool}\begin{ocamlindent}Проверяет, что TOTP уже настроена для пользователя. Возвращает: \ocamlinlinecode{true}, если пользователь может использовать TOTP.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-val-set+u+otp+u+secret}\ocamlcodefragment{\ocamltag{keyword}{val} set\_\allowbreak{}otp\_\allowbreak{}secret : \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{t}} \ocamltag{arrow}{$\rightarrow$} string \ocamltag{arrow}{$\rightarrow$} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{t}} \hyperref[xref-unresolved]{\ocamlinlinecode{Lwt}}.\allowbreak{}t}\begin{ocamlindent}Устанавливает TOTP секрет во время настройки. Возвращает обновлённого пользователя.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-val-set+u+otp+u+enabled}\ocamlcodefragment{\ocamltag{keyword}{val} set\_\allowbreak{}otp\_\allowbreak{}enabled : \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{t}} \ocamltag{arrow}{$\rightarrow$} bool \ocamltag{arrow}{$\rightarrow$} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{t}} \hyperref[xref-unresolved]{\ocamlinlinecode{Lwt}}.\allowbreak{}t}\begin{ocamlindent}Включает TOTP. Возвращает обновлённого пользователя.\end{ocamlindent}%
\medbreak
\end{ocamlindent}%
\ocamlcodefragment{\ocamltag{keyword}{end}}\\
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V}\ocamlcodefragment{\ocamltag{keyword}{module} \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V]{\ocamlinlinecode{V}}}\ocamlcodefragment{ : \ocamltag{keyword}{sig}}\begin{ocamlindent}\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-type-entity}\ocamlcodefragment{\ocamltag{keyword}{type} entity = \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{M.\allowbreak{}t}}}\begin{ocamlindent}тип \ocamlinlinecode{entity} - тип аутентифицируемой сущности, совпадающий с \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-type-MODEL-type-t]{\ocamlinlinecode{\ocamlinlinecode{MODEL.\allowbreak{}t}}}.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-val-authenticated}\ocamlcodefragment{\ocamltag{keyword}{val} authenticated : \hyperref[xref-unresolved]{\ocamlinlinecode{Base}}.\allowbreak{}bool \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}field}\begin{ocamlindent}\ocamlinlinecode{authenticated} - переменная, действительная в рамках одного запроса, отражает, была ли пройдена аутентификация ранее. Устанавливается в \ocamlinlinecode{SESSIONMANAGER}.auth\_setup.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-val-current+u+user}\ocamlcodefragment{\ocamltag{keyword}{val} current\_\allowbreak{}user : \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-type-entity]{\ocamlinlinecode{entity}} \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}field}\begin{ocamlindent}\ocamlinlinecode{current\_\allowbreak{}user} - переменная, действительная в рамках одного запроса, содержит аутентифицированную сущность (если ранее была пройдена аутентификация). Устанавливается в \ocamlinlinecode{SESSIONMANAGER}.auth\_setup\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-val-auth+u+error}\ocamlcodefragment{\ocamltag{keyword}{val} auth\_\allowbreak{}error : \hyperref[xref-unresolved]{\ocamlinlinecode{Base}}.\allowbreak{}Error.\allowbreak{}t \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}field}\begin{ocamlindent}\ocamlinlinecode{auth\_\allowbreak{}error} - field-переменная с ошибкой, которая могла произойти на любом этапе аутентификации. Устанавливается в \ocamlinlinecode{AUTHENTICATOR}.authenticate.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-val-update+u+current+u+user}\ocamlcodefragment{\ocamltag{keyword}{val} update\_\allowbreak{}current\_\allowbreak{}user : \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-type-entity]{\ocamlinlinecode{entity}} \ocamltag{arrow}{$\rightarrow$} \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$} \hyperref[xref-unresolved]{\ocamlinlinecode{Base}}.\allowbreak{}unit \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}promise}\begin{ocamlindent}\ocamlinlinecode{update\_\allowbreak{}current\_\allowbreak{}user user request} обновляет \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-3-V-val-current+u+user]{\ocamlinlinecode{\ocamlinlinecode{current\_\allowbreak{}user}}} и сессию. Необходимо использовать в том случе, если были внесены изменения, влияющие на сериализацию.\end{ocamlindent}%
\medbreak
\end{ocamlindent}%
\ocamlcodefragment{\ocamltag{keyword}{end}}\\
\subsubsection{Сигнатура\label{signature}}%
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-type-entity}\ocamlcodefragment{\ocamltag{keyword}{type} entity = \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-argument-2-M-type-t]{\ocamlinlinecode{M.\allowbreak{}t}}}\\
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-val-call}\ocamlcodefragment{\ocamltag{keyword}{val} call : 
  \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}request \ocamltag{arrow}{$\rightarrow$}
  \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-type-entity]{\ocamlinlinecode{entity}} \ocamltag{arrow}{$\rightarrow$}
  \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-type-entity]{\ocamlinlinecode{entity}} \hyperref[page-FPauth-core-module-FPauth+u+core-module-Static-module-StratResult-type-t]{\ocamlinlinecode{FPauth\_\allowbreak{}core.\allowbreak{}Static.\allowbreak{}StratResult.\allowbreak{}t}} \hyperref[xref-unresolved]{\ocamlinlinecode{Lwt}}.\allowbreak{}t}\begin{ocamlindent}\ocamlinlinecode{call} является главной функцией стратегии. Требует параметр "totp\_code", иначе пропускается. Проверяет, что код является верным для секрета пользователя. TOTP необходимо предварительно настроить.\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-val-routes}\ocamlcodefragment{\ocamltag{keyword}{val} routes : \hyperref[xref-unresolved]{\ocamlinlinecode{Dream}}.\allowbreak{}route}\begin{ocamlindent}\ocamlinlinecode{routes} предоставляет следующие маршруты в области видимости "/totp":\begin{itemize}\item{GET "/generate\_secret" является первым шагом для включения TOTP. Генерирует секрет для пользователя. Пользователь должен быть заранее аутентифицирован. Для пользователя стратегия не должна быть предварительно настроена.}%
\item{POST "/finish\_setup" является вторым шагом для включения TOTP. Должен получить "totp\_code" в качестве параметра, верифицирует его и включает TOTP в случае успешной верификации.}\end{itemize}%
\end{ocamlindent}%
\medbreak
\label{page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-module-Make-val-name}\ocamlcodefragment{\ocamltag{keyword}{val} name : string}\begin{ocamlindent}См. \hyperref[page-FPauth-strategies-module-FPauth+u+strategies-module-TOTP-val-name]{\ocamlinlinecode{\ocamlinlinecode{TOTP.\allowbreak{}name}}}\end{ocamlindent}%
\medbreak


